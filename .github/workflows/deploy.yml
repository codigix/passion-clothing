name: Deploy passion-clothing to VPS
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /var/www/passion-clothing

            # Save .env if it exists
            if [ -f "server/.env" ]; then
              cp server/.env /tmp/.env_backup
            fi

            # Reset to clean Git state
            git fetch origin main
            git reset --hard origin/main

            # Restore .env
            if [ -f "/tmp/.env_backup" ]; then
              mkdir -p server
              mv /tmp/.env_backup server/.env
            fi

            # Install and build
            cd server && npm install --production
            cd ../client && npm install && npm run build
            pm2 restart passion-erp